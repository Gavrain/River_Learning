# shiro权限管理

## 1：需要知道的东西

- 了解基于资源的权限管理方式
- 掌握权限数据模型
- 掌握基于URL的权限管理（不使用shiro实现权限管理）
- shiro实现用户认证
- shiro实现用户授权
- shiro与企业web项目整合开发

## 2：对权限管理的理解

只要有用户参与的系统一般都要有权限管理，权限管理实现对用户访问系统的控制，按照安全规则或者[安全策略](http://baike.baidu.com/view/160028.htm)控制用户可以访问而且只能访问自己被授权的资源。

权限管理包括用户认证和授权两部分

### 2.1：用户认证概念

用户认证：用户访问系统，系统要验证用户身份的合法性。最常用的用户身份验证的方法：

1：用户名密码

2：指纹打卡机

3：基于证书的验证方法

系统验证用户身份合法，用户方可访问系统资源



### 2.2：用户认证的流程

![mark](http://ozxf77u6w.bkt.clouddn.com/blog/180105/0f9F3CCah6.png?imageslim)





### 2.3：关键对象

**subject**：主体，理解为用户,可能是程序，都要去访问系统的资源，系统需要对subject进行身份认证。

**principal**：身份信息，通常是唯一的，一个主体还有多个身份信息，但是都有一个主身份信息（primary principal）

**credential**：凭证信息，可以是密码、证书、指纹。

总结：主体在进行身份认证时需要提供身份信息和凭证信息。

### 2.4： 用户授权概念

在用户认证通过之后，系统对用户访问资源进行控制，用户具有资源权限方可访问

### 2.5：授权的流程

![mark](http://ozxf77u6w.bkt.clouddn.com/blog/180105/1iE2fkAbhl.png?imageslim)

### 2.6：关键对象

授权的过程理解为：who对what(which)进行how操作。

who：主体即subject，subject在认证通过后系统进行访问控制。

what(which)：资源(**Resource**)，subject必须具备资源的访问权限才可访问该 资源。资源比如：系统用户列表页面、商品修改菜单、商品id为001的商品信息。

资源分为**资源类型和资源实例**：

系统的用户信息就是资源类型，相当于java类。

系统中id为001的用户就是资源实例，相当于new的java对象。

how：权限/许可(**permission**) ，针对资源的权限或许可，subject具有permission访问资源，如何访问/操作需要定义permission，权限比如：用户添加、用户修改、商品删除。



## 3：权限模型与分配

用户需要分配相应的权限才可访问相应的资源。**权限是对于资源的操作许可**。（重点：的注意一下这是的权限是相对于是资源的，不是相对于用户的）

通常给用户分配资源权限需要将权限信息持久化，比如存储在关系数据库中。

把用户信息、权限管理、用户分配的权限信息写到数据库（权限数据模型）



### 3.1：权限模型

主体（账号、密码）

[资源]()[（资源名称]()、访问地址）

权限（权限名称、资源id）

角色（角色名称）

角色和权限关系（角色id、权限id）

主体和角色关系（主体id、角色id）

![mark](http://ozxf77u6w.bkt.clouddn.com/blog/180105/IGcILh6LJF.png?imageslim)

通常企业开发中将资源和权限表合并为一张权限表，如下：

资源（资源名称、访问地址）

权限（权限名称、资源id）

合并为：

权限（权限名称、资源名称、资源访问地址）

![mark](http://ozxf77u6w.bkt.clouddn.com/blog/180105/i3il5kg5J5.png?imageslim)

**上图常被称为权限管理的通用模型，不过企业在开发中根据系统自身的特点还会对上图进行修改，但是用户、角色、权限、用户角色关系、角色权限关系是需要去理解的**



### 3.2：权限控制（核心授权）

#### 3.2.1：基于角色的访问控制

**RBAC**(role based  access  control)，基于角色的访问控制。

比如：系统角色包括：部门经理、总经理。。（角色针对用户来划分）

```java
系统代码中实现：
//如果该user是部门经理则可以访问if中的代码
if(user.hasRole('部门经理')){
	//系统资源内容
	//用户报表查看
}

问题：
角色针对人划分的，人作为用户在系统中属于活动内容，如果该 角色可以访问的资源出现变更，需要修改你的代码了，比如：需要变更为部门经理和总经理都可以进行用户报表查看，代码改为：

if(user.hasRole('部门经理') || user.hasRole('总经理')  ){
	//系统资源内容
	//用户报表查看
}

基于角色的访问控制是不利于系统维护(可扩展性不强)。

```

#### 3.2.2：基于资源的访问控制

**RBAC**(Resource  based access  control)，基于资源的访问控制。

资源在系统中是不变的，比如资源有：类中的方法，页面中的按钮

```java
if(user.hasPermission ('用户报表查看（权限标识符）')){
	//系统资源内容
	//用户报表查看
}

上边的方法就可以解决用户角色变更不用修改上边权限控制的代码。

如果需要变更权限只需要在分配权限模块去操作，给部门经理或总经理增或删除权限

```

## 4：权限管理解决方案

### 4.1：什么是粗粒度和细粒度权限

**粗粒度权限管理，对资源类型的权限管理**。资源类型比如：菜单、url连接、用户添加页面、用户信息、类方法、页面中按钮。。

粗粒度权限管理比如：超级管理员可以访问户添加页面、用户信息等全部页面。部门管理员可以访问用户信息页面包括 页面中所有按钮。

 

细粒度权限管理，对资源实例的权限管理。**资源实例就资源类型的具体化**，比如：用户id为001的修改连接，1110班的用户信息、行政部的员工。

**细粒度权限管理就是数据级别的权限管理。**

细粒度权限管理比如：部门经理只可以访问本部门的员工信息，用户只可以看到自己的菜单，大区经理只能查看本辖区的销售订单。。

 

粗粒度和细粒度例子：

 系统有一个用户列表查询页面，对用户列表查询分权限，如果粗颗粒管理，张三和李四都有用户列表查询的权限，张三和李四都可以访问用户列表查询。

进一步进行细颗粒管理，张三（行政部）和李四(开发部)只可以查询自己本部门的用户信息。张三只能查看行政部的用户信息，李四只能查看开发部门的用户信息。**细粒度权限管理就是数据级别的权限管理**



### 4.2：如何实现粗颗粒度和细颗粒度的权限管理

**如何实现粗粒度权限管理？**

粗粒度权限管理比较容易将权限管理的代码抽取出来在系统架构级别统一处理。比如：通过springmvc的拦截器实现授权

**如何实现细粒度权限管理？**

对细粒度权限管理在数据级别是没有共性可言，针对细粒度权限管理就是系统业务逻辑的一部分，如果在**业务层去处理相对比较简单**，如果将细粒度权限管理统一在系统架构级别去抽取，比较困难，即使抽取的功能可能也存在扩展不强。

建议细粒度权限管理在业务层去控制。

比如：部门经理只查询本部门员工信息，在service接口提供一个部门id的参数controller中根据当前用户的信息得到该用户属于哪个部门，调用service时将部门id传入service，实现该用户只查询本部门的员工。



### 4.3：基于url拦截的方式实现

基于url拦截的方式实现在实际开发中比较常用的一种方式。

对于web系统，通过filter过虑器实现url拦截，也可以springmvc的拦截器实现基于url的拦截



### 4.4：使用权限管理框架实现

对于粗粒度权限管理，建议使用优秀权限管理框架来实现，节省开发成功，提高开发效率。shiro就是一个优秀权限管理框架



## 5：基于url的权限管理

### 5.1：基于url权限管理流程

![mark](http://ozxf77u6w.bkt.clouddn.com/blog/180105/k9DA421cEE.png?imageslim)



