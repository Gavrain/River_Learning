# [并发编程1]聊聊并发

[TOC]

## 一、多线程与并发

 “高并发和多线程”总是被一起提起，给人感觉两者好像相等，实则 **高并发 ≠ 多线程**

　　多线程是完成任务的一种方法，高并发是系统运行的一种状态，通过多线程有助于系统承受高并发状态的实现。

　  高并发是一种系统运行过程中遇到的一种“短时间内遇到大量操作请求”的情况，主要发生在web系统集中大量访问或者socket端口集中性收到大量请求（例如：12306的抢票情况；天猫双十一活动）。该情况的发生会导致系统在这段时间内执行大量操作，例如对资源的请求，数据库的操作等。如果高并发处理不好，不仅仅降低了用户的体验度（请求响应时间过长），同时可能导致系统宕机，严重的甚至导致OOM异常，系统停止工作等。如果要想系统能够适应高并发状态，则需要从各个方面进行系统优化，包括，硬件、网络、系统架构、开发语言的选取、数据结构的运用、算法优化、数据库优化……而**多线程只是其中解决方法之一**。

实现高并发需要考虑：

- 系统的架构设计，如何在架构层面减少不必要的处理（网络请求，数据库操作等）
- 网络拓扑优化减少网络请求时间、如何设计拓扑结构，分布式如何实现？
- 系统代码级别的代码优化，使用什么设计模式来进行工作？哪些类需要使用单例，哪些需要尽量减少new操作？
- 提高代码层面的运行效率、如何选取合适的数据结构进行数据存取？如何设计合适的算法？
- 任务执行方式级别的同异步操作，在哪里使用同步，哪里使用异步？
- JVM调优，是以server模式还是以clien模式运行，如何设置Heap、Stack、Eden的大小，如何选择GC策略,控制Full GC的频率？
- 数据库优化减少查询修改时间。数据库的选取？数据库引擎的选取？数据库表结构的设计？数据库索引、触发器等设计？是否使用读写分离？还是需要考虑使用数据仓库？
- 缓存数据库的使用，如何选择缓存数据库？是Redis还是Memcache? 如何设计缓存机制？
- 数据通信问题，如何选择通信方式？是使用TCP还是UDP，是使用长连接还是短连接？NIO还是BIO？netty、mina还是原生socket？
- 操作系统选取，是使用winserver还是Linux？或者Unix？
- 硬件配置？是8G内存还是32G，网卡10G还是1G?

​            以上的这些问题在高并发中都是必须要深入考虑的，就像木桶原理一样，只要其中的某一方面没有考虑到，都会造成系统瓶颈，影响整个系统的运行。而高并发问题不仅仅涉及面之广，同时又要求有足够的深度！！！

　　　而多线程在这里只是在同/异步角度上解决高并发问题的其中的一个方法手段，是在同一时刻利用计算机闲置资源的一种方式。

## 二、线程与进程

- 进程：用专业的话就是，程序是指令和数据的有序集合，其本身没有任何运行的含义，是一个静态的概念。**而进程是程序在处理器上的一次执行过程**，它是一个动态的概念。是系统进行资源分配和调度的基本单位 。 
- 线程：是进程中的一个执行路径，**共享一个内存空间**，线程之间可以自由切换，并发执行，一个进程最少有一个线程（单线程程序）

下面的这个图很好的说明线程与进行之间的关系

![mark](http://ozxf77u6w.bkt.clouddn.com/blog/180714/eH6dm1gj4b.png?imageslim)

- 进程：每个进程都有**独立的代码和数据空间**（进程上下文），进程间的切换会有较大的开销，一个进程包含1–n个线程。（进程是资源分配的最小单位，进程切换回浪费很多的资源）
- 线程：**同一类线程共享代码和数据空间**，每个线程有独立的运行栈和程序计数器(PC)，线程切换开销小。（线程是cpu调度的最小单位）

## 三、并行与并发

并行：就是两个任务同时运行（多个CPU）

并发：是指两个任务同时请求运行，而处理器一次只能接受一个任务，就会把两个任务安排轮流执行，由于CPU时间片运行时间短，就会感觉两个任务在同时的执行

![mark](http://ozxf77u6w.bkt.clouddn.com/blog/180714/09BbG9jjCf.png?imageslim)

## 四、多线程一定比多线程快吗？

　　多线程编程的目的,就是"最大限度地利用CPU资源",当某一线程的处理不需要占用CPU而只和I/O,OEMBIOS等资源打交道时,让需要占用CPU资源的其它线程有机会获得CPU资源 。

看场景：效率的瓶颈不在代码的时候，比如用的最多的io操作，
**下载器**：下载服务器每个接口就给你500k的速度，那多线程相当于500*n，本地网络最大2m每秒，可以开3~5个线程自然快；
**复制器**：windows操作系统复制文件很慢，因为负责复制的api防止系统卡死每个线程就给你那点速度，如果用java写个多线程io流复制，速度快8倍左右；
**这样的场合有个特点，速度或者说效率的关键不是java的处理能力，而是接口限制成了瓶颈；**

举个反例，如果对一个集合进行遍历，打印value，使用多线程明显比单线程效率低；因为时间过多的消耗在了创建线程，销毁线程上，执行的有用代码和单线程没区别，效率不如单线程；

##五、 并发的缺点

- 安全性问题
- 活跃性问题（饥饿问题，死锁问题）
- 性能问题（线程不一定快）


