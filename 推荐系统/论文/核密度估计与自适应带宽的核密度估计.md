# 核密度估计与自适应带宽的核密度估计

[TOC]



## 基本的概率的知识的回顾

### 一、离散随机变量概率分布函数

对于离散型随机变量x，定义一个**概率函数叫f(x)**，它给出了随机变量取每一个值的概率。

拿出一个骰子，掷到6的概率是f(6) = 1/6，掷到1和6的概率则是f(1)+f(6) = 1/3。

既然随机变量可以取不同的值，统计学家就用**概率分布**描述随机变量取不同值的概率。

- 离散型的概率分布

![img](https://upload-images.jianshu.io/upload_images/742658-a442049c427bfc57.png?imageMogr2/auto-orient/)

![img](https://upload-images.jianshu.io/upload_images/742658-faf80a7b6dd92856.png?imageMogr2/auto-orient/)



我们来看看图上的公式，其中的F(x)就代表**概率分布函数**

### 二、连续型随机变量“概率密度函数”和“概率分布函数”

![img](https://upload-images.jianshu.io/upload_images/742658-c5652bd70c8e7643.png?imageMogr2/auto-orient/)

看看下面的这个公式：

![img](https://upload-images.jianshu.io/upload_images/742658-42bbf73877b1ab1c.png?imageMogr2/auto-orient/)





### 三、均匀分布的概率密度函数和分布函数

假设x服从[a,b]上的均匀分布，则x的概率密度函数如下

![img](https://img-blog.csdn.net/20170825170852511?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMjUzNTYwNQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

![img](https://img-blog.csdn.net/20170825171541966?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMjUzNTYwNQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)



分布函数图像如下图所示

![img](https://img-blog.csdn.net/20170825172518866?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMjUzNTYwNQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

![img](https://img-blog.csdn.net/20170825171601654?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMjUzNTYwNQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

## 参数估计

**参数估计** 
**参数估计**：是根据从总体中抽取的样本估计总体分布中包含的未知参数的方法。它是统计推断的一种基本形式，是数理统计学的一个重要分支，分为点估计和区间估计两部分。 

![img](https://img-blog.csdn.net/20160910223354000)

**点估计**：依据样本估计总体分布中所含的未知参数或未知参数的函数。

![img](https://img-blog.csdn.net/20160910223404813)

**区间估计（置信区间的估计）**：依据抽取的样本，根据一定的正确度与精确度的要求，构造出适当的区间，作为总体分布的未知参数或参数的函数的真值所在范围的估计。例如人们常说的有百分之多少的把握保证某值在某个范围内，即是区间估计的最简单的应用。 

![img](https://img-blog.csdn.net/20160910223412548)

### 一、最大似然估计

![mark](http://www.hhaxmm.cn/blog/20181219/7h33j4336ox0.png)

![mark](http://www.hhaxmm.cn/blog/20181219/zd8bIGPBsXgb.png)

## 非参数估计

参数估计要求明确参数服从什么分布，明确模型的具体形式，然后给出参数的估计值。根据从总体中抽取的样本估计总体分布中包含的未知参数。

非参数估计对**解释变量的分布状况与模型的具体形式不做具体规定 ，运用核密度函数与窗宽去逐步逼近**，找出相应的模型。统计学中常见的一些典型分布形式不总是能够拟合实际中的分布。此外，在许多实际问题中经常遇到多峰分布的情况，这就迫使必须用样本来推断总体分布，常见的总体类条件概率密度估计方法有Parzen窗法和Kn近邻法两种。 
**非参数估计也有人将其称之为无参密度估计，它是一种对先验知识要求最少，完全依靠训练数据进行估计，而且可以用于任意形状密度估计的方法**。

最简单的直方图估计，把所有可能取值的范围分成间隔相等的区间，然后看每个区间内有多少个数据？这样就定义出了直方图，因此直方图就是概率密度估计的最原始的模型。 
直方图用的是矩形来表示纵轴，当样本在某个小区间被观测到，纵轴就加上一个小矩形。

【1】非参数估计与参数估计不同：<font color ='red'>未对函数形式作出假设，直接从训练样本中估计出密度，从训练样本估计某一点的概率。</font>

【2】最简单的非参数估计：直方图 <font color ='red'>理解：直方图如果达到细化，就是概率密度函数。</font>

![mark](http://www.hhaxmm.cn/blog/20181219/9iBSI5zzXe5v.png)

简单理解一下公式：<font color ='red'>在x点发生的概率=（收集器区域内样本数/总的样本数）/收集器的宽度</font>

缺点<font color ='red'>：但是是离散的而且和收集器的起始位置有关（收集器的位置一变，落入区域的样本点个数就会发生变化）</font>

【3】将直方图进行推广。<font color ='red'>如果样本点足够多，空间体积减小。密度估计会趋于准备值。</font>

![mark](http://www.hhaxmm.cn/blog/20181219/jghnBcb4sW9V.png)

![mark](http://www.hhaxmm.cn/blog/20181219/HK7vWAB1DUjr.png)

注意：<font color ='red'>V不是越小越好，小到一定程度可能很难包含有效的样本。但过大的话会使宽度过宽，计算不准确。（我们不是想将直方图抽象成一条线么）</font>

【4】核函数密度估计之 parzen窗口

4.1定义核函数（数点器）。

（parzen窗口）理解：是中心在原点的单位超立方体。作用：值域只有0、1，是用来计数数点使用的。

![mark](http://www.hhaxmm.cn/blog/20181219/mnlsGBMmGyla.png)

4.2定义区域。

![mark](http://www.hhaxmm.cn/blog/20181219/GhE4mhj6LzTR.png)

4.3计数

![mark](http://www.hhaxmm.cn/blog/20181219/lyjagLWwHpRP.png)

除以h的目的是为了归一化吧。

4.4估计

![mark](http://www.hhaxmm.cn/blog/20181219/lbTOVMucVddk.png)

4.5  注意：核函数密度估计的期望与数据集合规模无关

## 核函数密度估计

核密度估计方法从直观上来看是平滑化的直方图，从理论角度上来讲是不利用数据分布的先验知识研究数据的分布特征。 优于直方图的一点是核密度估计是可以用于多维空间的。

### 直观理解

一组数据的直方图如下

![mark](http://www.hhaxmm.cn/blog/20181219/xEUceSapFGWc.png)

用KDE方法拟和出来的结果 

![mark](http://www.hhaxmm.cn/blog/20181219/FuASLaw10N0w.png)

### 理论
核密度估计方法是类似于激活函数的一种方法，这里激活函数变成了核函数(kernel)。对于取值于R的独立同分布随机变量x1,x2,...,xnx1,x2,...,xn，所服从的分布密度函数f(x)f(x)，核密度估计（也有称之为ParzenParzen窗法）得到的估计分布密度函数为

![mark](http://www.hhaxmm.cn/blog/20181219/uuwHFimEyRGT.png)

其中$h$为预设的正数，通常称为窗宽或光滑函数，$K_h$为核函数，一般需要满足以下条件：

![mark](http://www.hhaxmm.cn/blog/20181219/kBNMjKcm5tRs.png)

所以常用的核函数有：高斯核函数，Epanechnikov函数，Biweight函数等。 

### 核密度估计的性质 

关于核密度估计方法，除去对核函数的讨论，最影响其结果的 就是窗宽hh了：窗宽越小，观察到的数据点在最终的估计曲线比重越大，曲线越陡峭，反之。上图中的KDE增大窗宽，得到下图

![img](https://img-blog.csdn.net/20170419103418144?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvTGVvMDAwMDAwMDE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)



进一步增大窗宽可能发生波形融合：

![img](https://img-blog.csdn.net/20170419103435884?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvTGVvMDAwMDAwMDE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

### 举例子理解

由于高斯内核方便的数学性质，也经常使用$ K(x)=ϕ(x)，ϕ(x)$为标准正态概率密度函数。核密度估计与直方图很类似，但相比于直方图还有光滑连续的性质。

已知：6个数据点 
$x1=−2.1，x2=−1.3，x3=−0.4，x4=1.9，x5=5.1，x6=6.2$对于直方图，首先将水平轴划分为覆盖数据范围的子间隔或区段。在这种情况下，我们有6个宽度为2的矩形。每当数据点落在此间隔内时，我们放置一个高度为$1/12$的矩形。对于核密度估计，我们在每个数据点$xi$上放置方差2.25（由红色虚线表示）的正态核函数。叠加一起得到核密度估计的结果，蓝色线表示。 很明显，直方图得到的密度估计平滑程度比使用核密度估计得到的密度函数要差很多. 

现在问题是如何选定核函数的“方差”呢？这其实是由hh来决定，不同的带宽$h$下的核函数估计结果差异很大。

![mark](http://www.hhaxmm.cn/blog/20181219/udjNseGhYORv.png)

### 核带宽的选择 
带宽是一个自由参数，对所得到的估计值有很大的影响。为了说明效果，举个例子： 

下图是从标准正态分布中抽取的随机样本（横轴上的蓝色的点点代表样本点）灰色曲线是真是的概率密度（正态密度，均值0，方差1）。相比之下，红色曲线是使用了过小的带宽h(=0.05)h(=0.05)得出的概率密度曲线，可见其波折陡峭；绿色曲线过于平滑，因为它使用了过大的带宽h(=2)h(=2)，掩盖了数据大部分基础结构。 

![mark](http://www.hhaxmm.cn/blog/20181219/2VVsdFfPbFrC.png)

那么对于hh的选择可以使用最小化L2风险函数（即**平均积分平方误差**,mean intergrated squared error）。

![mark](http://www.hhaxmm.cn/blog/20181219/EcR9eyuPFOsd.png)

![mark](http://www.hhaxmm.cn/blog/20181219/6jXRnQqdSJIh.png)

这里$σ$是样品的标准差。这种近似称为*正态分布近似*，*高斯近似*，或*Silverman*（1986）*经验法则*。虽然这个经验法则很容易计算，但应谨慎使用，因为当密度不接近正态时，可能会产生泛化极差的估计。

### 带宽的作用简述

1.在数据可视化的相关领域中，带宽的大小决定了核密度估计函数（KDE）的平滑（smooth）程度，带宽越小越undersmooth，带宽越大越oversmooth。（详细解释） 
2.在POI兴趣点推荐领域，或位置服务领域，带宽$h​$的设置主要与分析尺度以及地理现象特点有关。==较小的带宽可以使密度分布结果中出现较多的高值或低值区域，适合于揭示密度分布的局部特征==，而较大的带宽可以在全局尺度下使热点区域体现得更加明显。另外，带宽应与兴趣点的离散程度呈正相关，对于稀疏型的兴趣点分布应采用较大的带宽，而对于密集型的兴趣点则应考虑较小一些的带宽。-

如果带宽不是固定的，而是根据样本的位置而变化(其变化取决于估计的位置（balloon estimator）或样本点（逐点估计pointwise estimator）)，则会产生一种特别有力的方法，称为自适应或可变带宽的核密度估计。就POI兴趣点推荐来说，由于密集的城市地区的签到密度很高，人烟稀少的农村地区的签到密度较低。就是说不同位置应该采取不同的分析尺度，因此本文采用不固定的带宽来进行核密度估计。

## 自适应带宽的核密度估计方法

这里再简单讨论一下自适应带宽的核密度估计方法。**自适应带宽的核密度估计方法**是在固定带宽核密度函数的基础上，通过修正带宽参数为而得到的，其形式如式所示：  

![mark](http://www.hhaxmm.cn/blog/20181219/vHk9y72Antbf.png)

这里$k(x)$是带宽为$h_j$的核密度估计函数，M是样例的个数，看出来了吧，每一个点$j$都有一个带宽$h_j$，因此这叫自适应或可变。$K(x)$是核函数，这里用了高斯核函数，当然也可以是其他的核函数。$0≤α≤1$，为灵敏因子，通常$α$取0.5，$α=0$时，自适应带宽的核密度估计就变成了固定带宽的核密度估计了。固定带宽的核密度估计就是前面说的核密度估计。$ω$表示带宽的参数。  



## POI的核密度估计的依据

核密度的计算方法是基于地理学第一定律，即距离越近的事物关联越紧密，与核心要素越近的位置获取的密度扩张值越大。在密度分布模式上，称这种空间特 征为 “距离衰减效应“，核 密 度法是地理空间设施分布特征提取的重要统计分析方法，==基于不同的空间距离概念可建立不同的核密度计算方法==。顾及城市网络空间中设施点的服务功能及相互联系发生于网络路径距离而非传统的欧氏距离的事实，仍然采用欧氏距离进行密度计算是不合理的，这样计算的结果可能高估道路交叉口旁的密度值

###  密度分析的扩展从欧氏空间到网络空间

密度是对空间现象的一种场表达，各位置根据其与相邻设施点的空间关系决定局部的聚集强度。密度分析是基于空间平滑及空间内插技术的统计分析过程。比较原始散点图对空间现象分布的简单表达，密度可以作为更精确的分析工具对空间特征分布作深层次的特征规律信息挖掘，特别是在完全空间随机（ＣＳＲ）的假设模式下，验证聚集或规律的空间分布特征，如犯罪热点分析［２１］、城市区域描述以及经济活动空间分布分析

### 空间点的密度计算方法

常用的点密度计算方法有**样方密度法**、**基于Ｖ 图**的密度法和**核密度法**

![mark](http://www.hhaxmm.cn/blog/20181221/3v8zt4kd5L86.png)

如图１所示，样方密度法是将研究区域分割成一系列均匀的子区域（即样方），计算落入各样方的点数与样方面积的比值，作为样方单元的密度；

而基于Ｖ图的密度法是将设施点作为 Ｖ 图发生元，计算各 Ｖ 图单元面积的倒数作为对应发生元的密度值。

**但是会产生两个问题：**

①单元空间内的密度是均一的，忽略了内部不同位置处点聚焦强度的差别；②单元连接处的密度变化突兀，忽略了空间现象发生的连续性

样方法中，由于在样方尺寸、样方方向、样方原点的选择上都具有不同程度的主观臆断性，容易造成原始数据信息的丢失；基于 Ｖ 图的方法会由于单元的划分而忽略 Ｖｏｒｏｎｏｉ单元内密度的变化以及造成相邻单元间的密度过于突兀。核密度以一种光滑曲面的形式渐进式传输中心强度，顾及和体现了空间位置的差异性以及中心强度随距
离衰减的特性，符合地理学第一定律。因此在实际应用中，样方法多用于计算具有固定边界的行政单元密度，如街区内的人口密度，全国范围内各省市的森林覆盖率等，基于 Ｖ 图的密度法适合于地理实体的势力范围评估，如河流汇水区域划分等，而核密度法更适合于对诸如城市设施服务影响、交通路段风险评估等连续性地理现象的密度
估计

**核密度方法**

可以解决以上问题，核密度值是随中心辐射距离的增大逐渐变小，考虑了设施点对它周围位置服务影响的距离衰减作用，核密度方法的计算方程可以表示为

![mark](http://www.hhaxmm.cn/blog/20181221/6E1yGjsEJnOK.png)

式中，ｆ（ｓ）为空间位置ｓ 处的核密度计算函数；ｈ为距离衰减阈值，ｎ 为与位置ｓ 的距离小于或等于ｈ 
的要素点数，ｋ函数则表示空间权重函数，这一方程的几何意义为密度 值在每个核心要素ｃｉ 处最大，并且在远离ｃｉ过程中不断降低，直至与核心ｃｉ的距离达到阈值ｈ 时核密度值降为０

核密度函数中存在两个关键参量，即空间权重函数ｋ 与距离衰减阈值ｈ。大量的研究表明空间权重函数的选择对点模式分布结果的影响不大，需要注意的是 距 离 衰 减 阈 值 的 选 择，在 实 际中，阈值ｈ 的设置主要与分析尺度以及地理现象特点有关。较小的距离衰减值可以使密度分布结果中出现较多的高值或低值区域，适合于揭示密
度分布的局部特征，而较大的距离衰减值可以在全局尺度下使热点区域体现得更加明显












