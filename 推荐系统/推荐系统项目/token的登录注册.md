# token机制完成登录状态保持/身份认证

# 前言

一般APP都是刚安装后，第一次启动时需要登录（提示你需要登录或者直接启动在登录界面）。而只要登录成功后，以后每次启动时都是登录状态，不需要每次启动时再次登录。不过，也有些APP若你长期未启动，再次启动时，它会提示你登录过期，让你重新登录。这个是怎么实现的？APP是怎么保持登录状态的？

之所以突然写这个话题，是因为昨晚无意间刷知乎刷到了这个问题[iOS系统如何实现app登录类似微信只需登录一次，退出后不需要每次登录?](https://link.jianshu.com?t=https://www.zhihu.com/question/33405900)
 回答里给出了好几种解决方案，其中比较标准的方案是**“带时效检测的token机制”**。所谓`token`，即“令牌”的意思。那这个token机制的执行逻辑是怎么样的呢？

# token机制

token机制的执行逻辑可以用下面一张图展示清楚：

![img](https://upload-images.jianshu.io/upload_images/988593-79cb65faa952c936.JPG?imageMogr2/auto-orient/)

当用户刚安装完APP，并进行了注册，拥有了账号和密码后。此时，则该进行首次登录了：

> APP将用户输入的账号和密码提交给服务器；
>  服务器对其进行校验，若账号和密码对得上则校验通过，说明登录成功。并生成一个`token`值，将其保存在数据库，同时也返回给客户端；
>  客户端拿到返回的`token`值后，可将其保存在本地。作为公共参数，即以后每次请求服务器时都携带该`token`，提交给服务器，让服务器校验。
>  服务器接收到请求后，会取出请求头里的`token`值与数据库存储的`token`进行对比校验。若两个`token`值相同，则说明用户登录成功过，且当前正处于登录状态，此时正常返回数据，让APP显示数据。若两个值不一致，则说明原来的的登录已经失效，此时返回错误状态码，提示用户跳转至登录界面重新登录。

> 用户每进行一次登录，登录成功后服务器都会更新个`token`新值返回给客户端。

基本的逻辑原理就是这些，下面我们看看项目代码中具体是怎么写的。

# 代码

首先看在登录界面发送登录请求那块。一开始我以为服务器返回的`token`值会在响应数据体中，也就是和用户信息在一起。但是我看了接口，并没有发现与`token`对应的字段。后来仔细看了下代码，原来`token`是在响应头中的。上面逻辑里的无论是存储`token`值，还是携带`token`作为公共参数，都是在网络层完成的。这一切都发生在网络层，而不麻烦业务层，这很优雅。

每当登录成功后，服务器在响应头中返回新的`token`值，将其保存在本地：

