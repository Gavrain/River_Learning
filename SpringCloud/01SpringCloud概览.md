# 微服务之SpringCloud-01

[TOC]



**背景**

软件的架构发展经历了从单体的架构、垂直架构、SOA架构到微服务架构的过程

## 1. 软件架构的演进

### 1.1 单体架构

![mark](http://man.hhaxmm.cn/blog/20190323/eG9KqvtNEinC.png)

特点：

1、所有的功能集成在一个项目中

2、所有的功能都打包成为一个war包部署到服务器上

3、应用与数据库分开

4、通过部署应用集群和数据库集群来提高系统的性能



优点：

1、项目简单，前期开发的成本低，周期短，小型项目首选



缺点：

1、全部的功能集成在一个工程中，对于大型的项目不易于开发、扩展和维护

2、系统性能的扩展只能通过扩展集群节点，成本高，有瓶颈

3、技术栈受限（一个项目只能有一种技术栈进行开发）

### 1.2 垂直架构

![mark](http://man.hhaxmm.cn/blog/20190323/GqpU1T3rXevT.png)

特点：

1、以单体结构规模的项目为单位进行垂直划分项目即将一个大项目拆分为一个个的单体架构

2、项目与项目之间存在数据冗余，耦合性较大，比如上图中三个项目都存在客户信息

3、项目之间的接口多为数据同步，如：数据库之间的数据同步，通过网络接口进行数据库之间的数据同步



优点：

1、项目的架构简单，前期开发成本低，周期短，小型项目的首选

2、通过垂直拆分，原来的单体架构不至于无限的扩大

3、不同的项目可以采用不同的技术



缺点：

1、全部的功能集成在一个工程中，对于大型的项目不易于开发

2、系统性能的扩展只能通过扩展集群节点，成本高，有瓶颈

### 1.3 SOA架构

![mark](http://man.hhaxmm.cn/blog/20190323/3mJEObYqT7r2.png)

特点：

1、基于SOA的架构思想将重复公用的功能抽取为**组件**，以服务的方式给各个系统提供服务。

2、各各项目（系统）与服务之间采用webservice，rpc等方式进行通信

3、ESB企业服务总线作为项目与服务之间通信的桥梁



优点：

1、将重复的功能抽取出来，提高开发效率，提高系统的可重用性、可维护

2、可以针对不同服务的特点定制集群及优化方案

3、采用ESB减少了系统的耦合



缺点：

1、系统与服务之间的界限模糊，不利用开发与维护

2、虽然使用了ESB，但是服务的接口协议不固定（http,webservice,tcp），种类繁多，不利于维护

3、抽取服务的粒度大，系统与服务之间的耦合度高

### 1.4 微服务架构

这是今年来最新的架构技术，随着移动互联网的出现而产生的

![mark](http://man.hhaxmm.cn/blog/20190324/I1aIaMCwU23R.png)

特点：

1、将系统服务层完全的独立出来，并将服务层抽取为一个个的服务

2、微服务遵循单一原则

3、微服务之间遵守RESTful等轻量级协议



优点：

1、服务拆分的粒度更细，有利于资源重复的利用，提高开发的效率

2、可以更加精准的对每个服务制定优化的方案，提高系统的可维护性能

3、微服务采用去中心化的思想，服务之间采用RESTful的轻量级协议，相比于ESB更加的轻量

4、使用于互联网，迭代周期短



缺点：

1、服务多，服务成本高，不利于系统维护

2、分布式系统开发的技术成本高（容错、分布式事务等）



> 去中心化的思想：SOA有ESB用来集成各个系统和服务，微服务架构没有ESB，服务网关相当于是路由器的概念，服务于服务之间都是可以进行通信的

## 2. 微服务概念

为了适应企业软件的发展，提高研发的生产力，降低企业的成本，软件架构也做了升级和优化，将一个独立的系统拆分为若干个不同的小服务，每个小服务运行在不同的进程中，服务于服务之间采用http轻量级通信协议（RESTful）传输数据，每个服务拥有独立的功能具有独立性强、高内聚的特点，这样的设计实现了单个服务的高内聚，服务于服务之间的低耦合，这一个个的小服务就是微服务，基于这种方法设计的系统架构即微服务架构。



## 3. SpringCloud技术栈

### 3.1 微服务技术栈

![mark](http://man.hhaxmm.cn/blog/20190324/JOyy3m6gjxR8.png)

负载均衡，网关路由：高可用、集群部署、校验、请求转发、服务集成

服务治理：服务注册、发现

容错：避免雪崩

监控跟踪：监控资源利用、服务响应、容器资源利用情况

消息总线：消息队列、异步通信

配置管理：统一配置管理

### 3.2 Spring Cloud是什么

Spring Cloud为开发人员构建微服务架构提供了完整的解决方案，SpringCloud是若干框架的整和，它包括spring-cloud-config、spring-cloud-bus 等近20个项目，它提供了服务治理、服务网关、智能路由、负载均衡、断路器、监控跟踪、分布式消息队列、配置管理等领域的解决方案。

### 3.3. Spring Cloud技术栈

服务治理：Dubbo(阿里巴巴) 、Dubbox(当当)、Eureka(Netflix)等

服务配置：Disconf(百度)、Qconf(360)、Diamood(淘宝)等

服务跟踪：Hydra(京东)、Zipkin(Twitter)、Sleuth(Spring Cloud)等

服务调用：Rest、RPC、gRPC

负载均衡：Ribbon、Nginx

消息队列：Kafka、RabbitMQ、ActiveMQ

服务部署：Docker、Kubernetes

|              | Dubbo         | Spring Cloud      |
| ------------ | ------------- | ----------------- |
| 服务注册中心 | Zookeeper     | Eureka            |
| 服务调用方式 | RPC           | REST API          |
| 服务监控     | Dubbo-monitor | Spring Boot Admin |
| 断路器       |               | Hystrix           |
| 服务网关     |               | Zuul              |
| 分布式配置   |               | Config            |
| 服务跟踪     |               | Sleuth            |
| 消息总线     |               | Bus               |
| 批量处理     |               | Task              |



Spring Cloud提供一站式的微服务架构，如下图：

![mark](http://man.hhaxmm.cn/blog/20190324/wxHtBFSGoswn.png)

## 4. 服务治理（核心）

微服务架构的缺点中最主要的就是由于微服务数量众多导致维护成本巨大，服务治理为解决此问题而产生的。服务治理的作用是让运维人员从人工维护的工作中解放出来，由服务自维护，<font color='red'>**微服务作为服务提供方主动向服务治理中心注册**</font>，服务的消费方通过服务治理中心查询需要的服务并进行调用。如下图

![mark](http://man.hhaxmm.cn/blog/20190324/Dp8GNiNcl6hE.png)

### 4.1 Spring Cloud Eureka

Spring Cloud Eurake 是对Netflix公司的Eurake的二次封装，它实现了服务治理的功能，Spring Cloud Eurake提供服务端与客户端，服务端即服务注册中心，客户端完成服务的注册和发现。服务端和客户端均采用java语言编写（Eurake支持多语言）。如下图显示了Eurake Server 与Eurake Client的关系：

![mark](http://man.hhaxmm.cn/blog/20190324/3bEy5DnpA5Yi.png)

### 4.2  架构

![mark](http://man.hhaxmm.cn/blog/20190324/oknsYy4k8HQc.png)



A：提供服务的方，需要把自己注册到服务治理中心，心跳是确保服务存活

B：消费服务的方，先从服务治理中心找到需要的服务，再使用RESTful进行调用

HA：保证服务治理中心的高可用

### 4.3 实战

![mark](http://man.hhaxmm.cn/blog/20190324/BCL4qI3xyALb.png)

#### 4.3.1 开发并部署Eureka Server

1、创建SpringBoot的工程

2、在POM文件中添加依赖，（SpringBoot ,Spring Cloud , Eureka Server）

3、配置application.yml

4、部署两台Eureka Server，并且相互注册，实现高可用



